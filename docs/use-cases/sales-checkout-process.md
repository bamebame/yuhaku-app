# 販売チェックアウトプロセス ユースケース

## 概要
店頭販売における商品販売から決済、レシート発行までの一連のプロセスを定義します。

## アクター
- **店舗スタッフ**: POSシステムを操作する従業員
- **顧客**: 商品を購入する客
- **POSシステム**: 販売管理システム
- **ReCORE API**: バックエンドAPI
- **レシートプリンター**: レシート印刷デバイス

## 前提条件
- スタッフがログイン済みである
- 販売ケースが作成済みである
- 商品がカートに追加されている

## 基本フロー

### 1. 決済前の準備
1. スタッフが編集画面で商品をカートに追加
2. 必要に応じて数量調整や価格調整を実施
3. 顧客情報（会員ID）を入力（任意）
4. クーポンを適用（任意）
5. ケース全体の調整金額を設定（任意）

### 2. 決済開始
1. スタッフが「決済へ進む」ボタンをクリック
2. システムが決済ダイアログを表示
3. 合計金額と内訳を確認

### 3. 支払い方法の選択
1. スタッフが支払い方法を選択：
   - **現金**: お預かり金額を入力
   - **クレジットカード**: カード読み取り処理
   - **電子マネー**: 端末での決済処理
   - **ギフト券**: ギフト券番号入力
2. 複数の支払い方法を組み合わせ可能

### 4. 現金決済の場合
1. お預かり金額を入力
2. システムがお釣りを自動計算
3. 金額不足の場合はエラー表示

### 5. 決済処理
1. スタッフが「決済完了」ボタンをクリック
2. システムがReCORE APIにチェックアウトリクエストを送信
3. 在庫の減算処理
4. 売上記録の作成
5. 販売ケースのステータスを「完了」に更新

### 6. レシート出力
1. 決済完了後、自動的にレシートデータを生成
2. レシートに含まれる情報：
   - 店舗情報（名称、住所、電話番号）
   - 取引日時
   - レシート番号
   - 担当スタッフ名
   - 商品明細（品名、数量、単価、金額）
   - 小計
   - 調整額（ある場合）
   - クーポン割引（ある場合）
   - 合計金額
   - お預かり金額（現金の場合）
   - お釣り（現金の場合）
   - 支払い方法
   - 会員情報（ある場合）
   - お客様メモ（ある場合）
3. レシートプリンターに印刷指示
4. 印刷完了を確認

### 7. 取引完了
1. システムが一覧画面に自動遷移
2. 次の顧客対応の準備

## 代替フロー

### A1. 決済エラー
1. ReCORE APIからエラーレスポンス
2. エラーメッセージを表示
3. 決済ダイアログに留まる
4. スタッフが内容を修正して再試行

### A2. レシート印刷エラー
1. プリンターエラーを検知
2. エラーメッセージを表示
3. 再印刷オプションを提供
4. 電子レシート送信オプション（メール）

### A3. 在庫不足
1. チェックアウト時に在庫不足を検知
2. 該当商品をハイライト表示
3. 数量調整または商品削除を促す

## 例外フロー

### E1. ネットワークエラー
1. API通信エラーを検知
2. ローカルに一時保存
3. オフラインモードで継続
4. 復旧後に自動同期

### E2. 決済キャンセル
1. 顧客が購入をキャンセル
2. スタッフが「キャンセル」ボタンをクリック
3. 編集画面に戻る
4. 販売ケースは編集可能な状態を維持

## 技術的実装

### API エンドポイント
```typescript
// チェックアウト処理
POST /api/recore/sas-cases/{id}/checkout
{
  "payments": [
    {
      "payment_id": "1",
      "payment_name": "現金",
      "amount": 10000
    }
  ]
}
```

### レスポンス
```typescript
{
  "success": true,
  "data": {
    "receipt_id": "RCP-2024-001234",
    "receipt_data": {
      // レシート印刷用データ
    }
  }
}
```

## セキュリティ考慮事項
- 決済情報は暗号化して送信
- クレジットカード情報はPCIDSS準拠
- 操作ログの記録
- 権限チェック（チェックアウト権限）

## パフォーマンス要件
- チェックアウト処理: 3秒以内
- レシート生成: 1秒以内
- レシート印刷開始: 2秒以内

## 今後の拡張
- QRコード決済対応
- 電子レシート機能
- ポイント付与連携
- 売上分析ダッシュボード連携
- 複数店舗間の在庫調整